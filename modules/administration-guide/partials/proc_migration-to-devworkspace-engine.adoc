
[id="migration-to-devworkspace-engine_{context}"]
= Migration to {devworkspace} engine.

This procedure describes how to migration to {devworkspace} engine using https://docs.openshift.com/container-platform/latest/operators/understanding/olm/olm-understanding-olm.html[OLM] to support the Devfile 2.0.0 file format and mentions how to do so on existing instances.

.Prerequisites

* The `{orch-cli}` tool is available.
* An instance of {prod-short} deployed using xref:installation-guide:installing-che-on-openshift-4-using-operatorhub.adoc[Operator Hub] from `{prod-channel}` channel on OpenShift cluster version greater or equal to 4.8
* OpenShift OAuth is enabled. See xref:configuring-openshift-oauth.adoc[].
* Bundled PostgreSQL

.Procedure

. All workspaces must be stopped and changes pushed back to Git repositories.

. Backup {prod-short} data. See xref:managing-backups-using-chectl.adoc[].

include::partial$snip_scaling-down-che.adoc[]

. Create the script to get all {prod-short} users:
+
[source,shell,subs="+attributes"]
----
cat >get-all-{prod-id}-users.sh<<EOF
#!/bin/bash
set -e

ALL_USERS={prod-id}-users.txt
IDENTITY_PROVIDER_URL=\$({orch-cli} get checluster {prod-checluster} -n {prod-namespace} -o jsonpath="{.status.keycloakURL}" )
IDENTITY_PROVIDER_SECRET=\$({orch-cli} get checluster/{prod-checluster} -n {prod-namespace} -o jsonpath="{.spec.auth.identityProviderSecret}")
IDENTITY_PROVIDER_PASSWORD=\$(if [ -z "\$IDENTITY_PROVIDER_SECRET" ] || [ \$IDENTITY_PROVIDER_SECRET = "null" ]; then {orch-cli} get checluster/{prod-checluster}  -n {prod-namespace} -o jsonpath="{.spec.auth.identityProviderPassword}"; else {orch-cli} get secret \$IDENTITY_PROVIDER_SECRET -n {prod-namespace} -o jsonpath="{.data.password}" | base64 -d; fi)
IDENTITY_PROVIDER_USERNAME=\$(if [ -z "\$IDENTITY_PROVIDER_SECRET" ] || [ \$IDENTITY_PROVIDER_SECRET = "null" ]; then {orch-cli} get checluster/{prod-checluster}  -n {prod-namespace} -o jsonpath="{.spec.auth.IdentityProviderAdminUserName}"; else {orch-cli} get secret \$IDENTITY_PROVIDER_SECRET -n {prod-namespace} -o jsonpath="{.data.user}" | base64 -d; fi)
IDENTITY_PROVIDER_REALM=\$({orch-cli} get checluster {prod-checluster} -n {prod-namespace} -o jsonpath="{.spec.auth.identityProviderRealm}")

refreshToken() {
    IDENTITY_PROVIDER_TOKEN=\$(curl -ks \
    -d "client_id=admin-cli" \
    -d "username=\${IDENTITY_PROVIDER_USERNAME}" \
    -d "password=\${IDENTITY_PROVIDER_PASSWORD}" \
    -d "grant_type=password" \
    "\${IDENTITY_PROVIDER_URL}/realms/master/protocol/openid-connect/token" | jq -r ".access_token")
}

run() {
  rm -f \${ALL_USERS}
  refreshToken
  USER_IDS=(\$(curl -ks  -H "Authorization: bearer \${IDENTITY_PROVIDER_TOKEN}" "\${IDENTITY_PROVIDER_URL}/\${IDENTITY_PROVIDER_USERNAME}/realms/\${IDENTITY_PROVIDER_REALM}/users" | jq ".[] | .id" | tr "\r\n" " "))

  for USER_ID in "\${USER_IDS[@]}"; do
      refreshToken

      USER_ID=\$(echo "\${USER_ID}" | tr -d "\"")
      FEDERATED_IDENTITY=\$(curl -ks -H "Authorization: bearer \${IDENTITY_PROVIDER_TOKEN}" "\${IDENTITY_PROVIDER_URL}/\${IDENTITY_PROVIDER_USERNAME}/realms/\${IDENTITY_PROVIDER_REALM}/users/\${USER_ID}/federated-identity")
      IDENTITY_PROVIDER=\$(echo "\${FEDERATED_IDENTITY}" | jq -r ".[] | select(.identityProvider == \"openshift-v4\")")
      if [ -n "\${IDENTITY_PROVIDER}" ]; then
        OPENSHIFT_USER_ID=\$(echo "\${IDENTITY_PROVIDER}" | jq ".userId" | tr -d "\"")
        echo "[INFO] Find {prod-short} user: \${USER_ID} and corresponding OpenShift user: \${OPENSHIFT_USER_ID}"
        echo "\${USER_ID} \${OPENSHIFT_USER_ID}" >> \${ALL_USERS}
      fi
  done
}

run
echo "[INFO] Done."
EOF

bash get-all-{prod-id}-users.sh
----

include::partial$snip_scaling-down-keycloak.adoc[]

include::partial$snip_finding-che-database-name.adoc[]

include::partial$snip_finding-postgresql-pod.adoc[]

include::partial$snip_dumping-che-database.adoc[]

include::partial$snip_droping-che-database.adoc[]

include::partial$snip_creating-che-database.adoc[]

. Migrate {prod-short} users:
+
[subs="+quotes,+attributes"]
----
DUMP="che.sql"
ALL_USERS={prod-id}-users.txt
while IFS= read -r line
do
  IDS=($line)
  USER_ID=${IDS[0]}
  OPENSHIFT_USER_ID=${IDS[1]}

  sed -i -e "s|${USER_ID}|${OPENSHIFT_USER_ID}|g" "${DUMP}"

  echo "[INFO] Migrated User ID from \"${USER_ID}\" to \"${OPENSHIFT_USER_ID}\""
done < "${ALL_USERS}"
----

include::partial$snip_restoring-che-database.adoc[]

. Add empty users profiles:
+
[subs="+quotes,+attributes"]
----
ALL_USERS={prod-id}-users.txt
while IFS= read -r line
do
  IDS=($line)
  OPENSHIFT_USER_ID=${IDS[1]}

  {orch-cli} exec $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql ${CHE_POSTGRES_DB} -tAc \"insert into profile(userid) values ('${OPENSHIFT_USER_ID}');\""

  echo "[INFO] Added profile for \"${OPENSHIFT_USER_ID}\""
done < "${ALL_USERS}"
----

. Find Cluster Service Version name:
+
[subs="+quotes,+attributes"]
----
CSV=$({orch-cli} get subscription {prod-id} -n {prod-namespace} -o jsonpath="{.status.currentCSV}")
----

. Delete Cluster Service Version:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete csv ${CSV} -n {prod-namespace}
----

. Delete Subscription:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete subscription {prod-id} -n {prod-namespace}
----

. Enable {devworkspace} engine:
+
[subs="+quotes,+attributes"]
----
{orch-cli} patch checluster/{prod-checluster} -n {prod-namespace} --type=json -p \
'[{"op": "replace", "path": "/spec/devWorkspace/enable", "value": true}]'
----

. Enable single-host exposure strategy:
+
[subs="+quotes,+attributes"]
----
{orch-cli} patch checluster/{prod-checluster} -n {prod-namespace} --type=json -p \
'[{"op": "replace", "path": "/spec/server/serverExposureStrategy", "value": "single-host"}]'
----

. Delete {identity-provider} route:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete route keycloak -n {prod-namespace}
----

. Delete {identity-provider} service:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete service keycloak -n {prod-namespace}
----

. Delete {identity-provider} deployment:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete deployment keycloak -n {prod-namespace}
----

. Create a new subscription to `{prod-tech-preview-channel}` channel:
+
[subs="+quotes,+attributes"]
----
{orch-cli} apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: {prod-id}
  namespace: openshift-operators
spec:
  channel: {prod-tech-preview-channel}
  installPlanApproval: Automatic
  name: {prod-tech-preview-olm-package}
  source: {prod-catalog-source}
  sourceNamespace: openshift-marketplace
EOF
----

. Wait until Operator is ready:
+
:k8s-component: {prod-operator}
:k8s-namespace: openshift-operators
include::partial$snip_waiting-for-component.adoc[]

. Wait until {prod-short} is ready:
+
:k8s-component: {prod-deployment}
:k8s-namespace: {prod-namespace}
include::partial$snip_waiting-for-component.adoc[]

include::partial$snip_verification-che-working.adoc[]
